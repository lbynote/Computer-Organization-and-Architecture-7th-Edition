# 3.1 计算机的部件

冯·诺依曼结构基于以下3个关键性的概念：
1. 数据和指令存储在单一的“读写存储器”中。
2. 存储器的内容通过位置寻址，而不考虑它容纳的数据是什么。
3. 以顺序的形式从一条指令到下一条指令来（除非有明确的修改）执行。

为了和内存交换数据，CPU一般使用两个内部寄存器：
1. 存储地址寄存器（MAR），为下一次读或者写指定内存地址。
2. 存储缓冲寄存器（MBR），容纳写到内存或从内存接收的数据。
类似地，一个I/O地址寄存器（I/O AR）指定了一个特定的I/O设备；I/O缓冲寄存器（I/O BR）用于I/O模块和CPU的数据交换。

内存模块包含一组单元，有连续的编号来定义其地址。每个单元都含有一个二进制数，它既可以解释为指令也可解释为数据。

I/O模块将数据从外设传送到CPU或存储器，反之亦然。I/O模块包含内部缓冲器，用来暂时存储I/O数据，知道它们被发送出去。

# 3.2 计算机功能

一条指令所要求的处理过程称为指令周期。指令周期又分为取值周期和执行周期。

## 3.2.1 指令的取和执行

每条指令周期开始时，CPU都从存储器中取指令。在典型的CPU中，用一个称为程序计数器(PC)的寄存器来保存待取指令的地址。除非特别指明，否则CPU在每次取指令之后总是将PC的值加上一个增量，以便顺序地取出下一条指令（也就是内存中下一条更高地址的指令）。

读取的指令装入CPU中的指令寄存器(IR)。指令以二进制代码的形式存在，它规定了CPU将要执行的动作。CPU解释这条指令并完成所要求的操作。总的来说，这些操作归为4类：
1. CPU-存储器：数据可从CPU传送到存储器或从存储器传送到CPU。
2. CPU-I/O：通过CPU和I/O模块之间的传输，数据可传送到或来自外部设备。
3. 数据处理：CPU可执行对数据的一些算术或逻辑操作。
4. 控制：指令可用来指定改变执行顺序。

基本指令周期中的状态描述：
1. 指令地址计算(instruction address calculate, iac)：决定下一条要执行指令的地址。
2. 读取指令(instruction fetch, if)：将指令从内存单元读到CPU中。
3. 指令操作译码(instruction operate decode, iod)：分析指令，以决定执行何种操作以及所用的操作数。
4. 操作数地址计算(operand address calculate, oac):如果操作包含对存储器或通过I/O的操作数的访问，那么必须决定操作数的地址。
5. 取操作数(operand fetch, of)：从存储器或从I/O中读取操作数。
6. 数据操作(data operate, do)：完成指令所给出的操作。
7. 存储操作数(operand storage, os)：将结果写入存储器或输出到I/O。

## 3.2.2 中断

中断的分类：

| 中断类型 | 产生的原因 |
| :- | :- |
| 程序 | 由指令执行结果伴随而出现的某些条件所产生。例如，算术溢出、除以零、企图执行一些非法的及其指令以及访问的地址超出了用户存储器空间。 |
| 定时器 | 由处理器中的定时器产生，它允许操作系统以规整的时间间隔执行特定的功能。 |
| I/O | 由/O控制器产生，以通知操作正常完成或各种出错情况。 |
| 硬件故障 | 如电源故障或存储器奇偶校检差错这类的故障产生。 |

### 3.2.2.1 中断和指令周期

如果出现中断请求，则处理器执行如下操作：
1. 挂起当前正在执行的程序，并保存状态。这意味着保存下一条即将执行的指令的地址（程序计数器PC的当前内容）和任何与处理器当前活动相关联的数据。
2. 将程序计数器(PC)设置为中断处理例程的起始地址。

### 3.2.2.2 多重中断

处理多重中断有两种方法：
1. 顺序处理中断：在中断处理过程中禁止其他中断。这种方法的缺点是没有考虑相对的优先级和时间的紧迫。
2. 嵌套中断处理：定义中断的优先级，且允许优先级高的中断引起低级中断处理例程本身被中断。

## 3.2.3 I/O功能

I/O模块能与CPU直接交换数据。  
某些情况下，需要I/O直接同内存交换数据。这种情况下，CPU授予I/O模块读/写存储器的权利，这样，I/O和存储器的传输就不需要CPU的介入。这种操作称为直接存储器访问(DMA)。

# 3.3 互连结构

连接各种模块的通路的集合称为互连结构(interconnection structure)。

# 3.4 总线互连

总线(bus)是连接两个或多个设备的通信通路。总线的关键特征是共享传输介质。多种设备连接到总线上，一个设备发出的信号可以被其他所有连接到总线上的设备所接收。如果两个设备同时发送，它们的信号将会重叠，这样会引起混淆。因此，每次只有一个设备成功地利用总线发送数。  
多数情况下，总线由多条通信路径或线路组成，每条线能够传送代表二进制1和0的信号。  
连接计算机主要部件（处理器、存储器、I/O）的总线称为系统总线。最常见的计算机互连结构使用一个或多个系统总线。

## 3.4.1 总线结构

任何总线的线路都可以分成如下3个功能组：**数据总线、地址总线和控制总线**。此外，还有为连接的模块提供电源的电源馈线。

数据线提供系统模块间传送数据的路径，这些线组合在一起称为数据总线。典型的数据总线包含8、16或32根线，这些线的数目为数据总线的宽度。

地址线用于指定数据总线上数据的来源或去向。显然，地址总线的宽度决定了系统能够使用的最大的存储器容量。而且地址线通常也用于I/O端口的寻址。在实际应用中，地址线的高位用于选择总线上指定的模块（区域），地位用于选择模块内具体的存储器单元或I/O端口。

控制线用来控制对数据地址线的存取和使用。控制信号在系统模块之前发送命令和时序信号。时序信号指定了数据和地址信息的有效性，命令信号指定了要执行的操作。  
典型的控制信号如下：
1. 存储器写(Memory Write)：引起总线上的数据写入被寻址单元。
2. 存储器读(Memory Read)：使所寻址单元的数据放到总线上。
3. I/O写(I/O Write)：引起总线上的数据输出到被寻址的I/O端口。
4. I/O读(I/O Read)：使被寻址的I/O端口的数据放到总线上。
5. 传输响应(Transfer ACK)：表示数据已经被接收，或已把数据放到了总线上。
6. 总线请求(Bus Request)：表示某个模块需要获得对总线的控制。
7. 总线准许(Bus Grant)：表示发出请求的模块已经被允许控制总线。
8. 中断请求(Interrupt Request)：表示某个中断正在悬而未决。
9. 中断响应(Interrupt ACK)：未决的中断请求被响应。
10. 时钟(Clock)：用于同步操作。
11. 复位(Reset)：初始化所有模块。

如果一个模块希望向另一个模块发送数据，它必须做两件事：
1. 获得总线的使用权。
2. 通过总线传送数据。

如果一个模块希望向另一个模块请求数据，它也必须做两件事：
1. 获得总线的使用权。
2. 通过适当的控制线和地址线向另一个模块发送请求，然后它必须等待另一个模块发送数据。

## 3.4.2 多总线层次结构

如果大量的设备连到总线上，性能就会下降，这主要有两个原因：
1. 总的来说，总线上连接的设备越多，传输延迟就越大。
2. 当聚集的传输请求接近总线容量时，总线便会成为瓶颈。

![传统总线结构](/img/传统总线结构.jpg/)
局部总线连接处理器和高速缓存，它可用于支持一个或多个局部设备。高速缓存控制器不但将高速缓存连接到局部总线，而且将它连到接入了所有主存储器模块的系统总线。使用高速缓存避免了处理器对主存储器的频繁访问。

![高性能总线结构](/img/高性能总线结构.jpg/)
在性能越来越高的I/O设备面前，为满足这些不断增长的需要，工业上采用的普遍方法是构造与系统其余部分紧密集成的高速总线，而它仅要求一个在处理器总线和高速总线之间的桥。有时称这种方案为中间层结构。  
高速缓存控制器集成到连接高速总线的桥或缓冲设备中。低速设备仍然由扩充总线支持，以接口来缓冲扩展总线和高速总线之间的传输量。  
这种安排的好处是，高速总线使高需求的设备与处理器有更紧密的集成，同时又独立于处理器。于是，不同的处理器和高速总线速度及信号线定义都可以兼容。处理器结构的变化不影响高速总线，反之亦然。

## 3.4.3 总线设计要素

总线设计要素：

| 类型 | 仲裁方法 | 时序 | 总线宽度 | 数据传输类型 |
| :-: | :-: | :-: | :-: | :-: |
| 专用/复用 | 集中式/分布式 | 同步/异步 | 地址/数据 | 读/写/读-修改-写/写后读/块 |

### 3.4.3.1 总线类型

总线的信号线可以归为两类：专用的和复用的。专用总线始终只负责一项功能，或始终分配给计算机部件的一个物理子集。  
功能专用的一个例子是使用分立专用的地址线和数据线，这种情况在许多总线中很常见。  
专用总线指的是使用多条总线，每一总线仅与模块的一个子集相连接。物理专用的潜在优点是总线冲突减少，所以具有高吞吐量；缺点是增加了系统的规模和成本。  
分时复用：用地址有效(address valid)控制线来控制，地址和数据信息就可以通过同一组线传输。在数据传送的开始，地址放在总线上，地址有效线被激活。在这一点，每个模块在规定的一段时间内复制地址，并判断自己是否是被寻址的模块。然后地址从总线上撤销，相同的总线连线随后用于读写数据的传输。  
分时复用的优点是使用的布线数量少，从而节省了空间和成本；其缺点是控制电路略显复杂，而且还具有性能降低的潜在可能，因为共享总线的特定事件不能同时发生。

### 3.4.3.2 总线仲裁方法

在除最简系统之外的所有系统中，可能有不止一个模块需要使用或控制总线。由于在总线上每次只有一个器件能够成功地发送，因此需要某种仲裁方法。各种仲裁方法可以大致划分为“集中式”和“分布式”两类。  
在集中式的方法中，一个称为总线控制器或仲裁器的硬件设备负责分配总线时间。这个设备可以是独立的模块，也可以是CPU的一部分。  
在分布式的方法中，没有中央控制器，而是在每个模块中包含访问控制逻辑，这些模块共同作用，分享总线。  
这两种仲裁方法的目的都是为了指定一个设备（CPU或I/O模块）作为主控器。然后这个主控器启动与其他设备的数据传输（例如读或写），后者在这一次数据交换中作为从属设备。

### 3.4.3.3 时序

>#### 时序图
>![信号作为定时功能](/img/时序图a.jpg/)
时序图能够将信号电平作为时间的函数表示。习惯上二进制1用比二进制0高的电平表示。通常，二进制0是默认值。也就是说，如果不传输数据和其他信号，线上是代表二进制0的电平。  
一个从0到1过渡信号一般被称为信号的上升沿(leading edge)，从1到0的过渡被称为下降沿(trailing edge)。  
为清晰起见，通常认为信息的过渡是瞬间发生的。实际上，过渡的时间并不为零，但它与信号持续的时间相比非常小。  
有时，在我们感兴趣的事件之间要经过一段时间，这段时间长度是变化的，或至少与问题无关。它用时间线上的一条间隙表示。
>![一组信号线](/img/时序图b.jpg/)
信号有时成组表示。例如，如果一次传送一个字节的数据，则需要8条线，通常我们只想知道信号是否出现，而这一组线中的确切值对我们并不重要。
![边沿触发关系](/img/时序图c.jpg/)
一条线上的信号跳变可能触发与之相连的设备改变其他信号线上的信号。例如，如果存储器模块检测到一个读控制信号(0或1跳变)，它将把数据信号放到数据线上，这样的因果关系产生了事件的序列。时序图上的箭头用于表示它们的依赖关系。
![时钟信号](/img/时序图d.jpg/)
时钟信号CLK通常是系统总线的一部分。一个时钟电路接到时钟线上并提供重复的规则跳变序列。其他事件会与时钟信号保持同步。

时序指总线上协调事件的方式，总线使用同步时序或异步时序。  
对于同步时序，总线上的事件的发生由时钟决定。总线中包含时钟信号线，它传送相同长度的由0、1交替的规则信号组成的时钟序列。一次1-0传送被称为时钟周期或总线周期，它定义了一个时间槽。总线上其他所有设备都能读取时钟线，而且所有的事件都在时钟周期的开始时发生。大多数事件占用一个时钟周期。  
对于异步时序来说，总线上一个事件的发生取决于前一事件的发生。  
同步时序的实现和测试都更简单，但是同步时序没有异步时序灵活，因为同步总线上的所有设备都遵循固定的时钟频率，系统不能发挥高性能设备的优势。对于异步时序来说，不论设备是快还是慢，使用的技术是新还是旧，都可以共享总线。

### 3.4.3.4 总线宽度

数据总线的宽度对系统性能有重要影响：数据总线越宽，一次能传送的位数就越多。  
地址总线的宽度对系统容量有重要影响：地址总线越宽，可以访问的单元就越多。

### 3.4.3.5 数据传输类型

所有的总线都支持写（主控器到从属设备）和读（从属设备到主控器）的传输。  
“读-修改-写”操作是在读之后紧接着向同一地址写数据。地址仅在操作的开始广播一次。为了防止其他潜在的主控器访问此数据单元，整个操作是不可分的。  
“写后读”也是一种不可分割的操作，它是指写之后紧接着对同一地址的读取，这个读操作可用于校检。  
有些总线还支持数据的“成块传输”。在这种情况中，一个地址周期后面跟着n个数据周期。第一个数据项传输使用指定的地址，其余的数据项传输使用后续地址。

# 3.5 PCI

PCI(peripheral component interconnect, 外部设备互连)总线是一种高带宽、独立于处理器的总线，它能够作为中间层或外围设备总线。与其他普通的总线规范相比，PCI为高度的I/O子系统（例如，图形显式适配器、网络接口控制器、磁盘控制器，等等）提供了更高的性能。  
然而，PCI的优势不仅仅是它的高速度，PCI是专门为满足现代系统的I/O要求而设计的较经济的总线。实现它只要很少的芯片，而且它支持把其他总线连到PCI总线上。  
PCI支持广泛的基于微处理器的配置，包括单处理器和多处理器系统。相应地，它提供了一组通用的功能，并使用同步时序以及集中式冲裁机制。

## 3.5.1 总线结构

PCI可以配置成32位或64位总线。49线的PCI所必需的信号线，按功能可以分为以下几组：
1. 系统引脚：包括时钟和复位引脚。
2. 地址和数据引脚：包含32根分时复用的地址/数据线。在此PCI布线方案中，用其他信号线来解释并使传送的地址和数据的信号线有效。
3. 接口控制引脚：控制数据交换的时序，并提供发送端和接收端的协调。
4. 仲裁引脚：不同于其他PCI信号线，它们是非共享线，每个PCI主控器有自己的一对仲裁线，它们直接连到PCI总线仲裁器上。
5. 错误报告引脚：用于报告奇偶校检错以及其他错误。

此外PCI规范还定义了51个可选的信号线，可分为以下几个功能组：
1. 中断引脚：它们提供给必须请求服务的PCI设备。同仲裁引脚一样，它们是非共享的。PCI设备有自己的中断线或连接到中断控制器的线。
2. 高速缓存支持引脚：需要用这些引脚来支持在处理器或其他设备中能被高速缓存的PCI的存储器。这些引脚支持高速缓存监听协议。
3. 64位总线扩展引脚：包含32根分时复用的地址/数据线。它们与必有的地址/数据线一道，形成64位地址/数据总线。这一组中其余的线用于解释传送地址数据的信号并使之有效。最后，还有使两个PCI设备具有64位能力的两根线。
4. JTAG/边界扫描引脚：这些信号线支持IEEE标准1149.1中定义的测试程序。

## 3.5.2 PCI命令

在发送端（或称主控方）与目标之间进行信息交换时，总线活动开始。当总线的主控方获得总线控制权后，由主控方决定即将发生的事项类型。在地址传送周期，C/BE（命令/字节）只是信号线指示事项类型。这些命令有：
1. 中断响应：中断响应是一条读命令，其目的是为了让PCI总线上的中断控制器设备进行操作。此时，地址传送周期中地址线并不使用，而字节允许信号可返回的中断标识号。
2. 特殊周期：用来由发送端向一个或多个目标发送广播信息。
3. I/O读和I/O写：用来在发送端和I/O控制器之间传送数据。每个I/O设备有自己的地址，地址/数据线用来指出特定的设备并向指定设备发送或从设备接收数据。
4. 存储器读和存储器写：用于激发数据的突发式传输，传输占用一个或多个时钟周期。这些命令的解释依赖于总线上的存储器、控制器是否支持在存储器和高速缓存之间进行存储。如果PCI协议支持，与存储器之间的数据传输一般是以高速缓存行，或块来进行。
5. 存储器写命令用于向存储器传送数据，它占用一个或多个数据周期。
6. 存储器写和无效命令用一个或多个周期传送数据。而且，它保证至少有一个高速缓存行是写操作。这条命令支持向存储器会写一行的高速缓存操作。
7. 配置写和配置读命令时主控器能够读和更新与PCI相连设备的配置参数。每个PCI设备可能包含最多256个内部寄存器，它们用来在系统初始化时配置设备。
8. 双地址周期命令由发送端来指示它使用64位寻址。
9. 3个存储器读命令的用途：

| 读命令类型 | 可高速缓存内存 | 不可高速缓存内存 |
| :-: | :-: | :-: |
| 存储器读 | 突发传送一半或不到一个高速缓存行的数据 | 突发2个数据传输周期或更少 |
| 存储器行读 | 突发传送一半或3个高速缓存行的数据 | 突发3个到12个数据传输周期 |
| 存储器多读 | 突发传送3个以上的高速缓存行的数据 | 突发超过12个数据传送周期 |

## 3.5.3 数据传送

PCI上的数据传送是由一个地址周期和一个或多个数据周期组成的单一事项过程。

![PCI读操作](/img/PCI读操作.jpg/)
上图显示了读事项的时序。所有事件均在时钟的下降沿同步，即在每个时钟周期的中央。总线设备在总线周期开始时的上升沿对总线路采样。重要事件：  
- (a) 一旦总线的主控器获得主线的控制权，它通过使FRAME有效（降低为低电平）来启动事项，FRANE线将一直保持有效，直到发送端就绪完成最后一次的数据传送。FRAME有效之后，发送端把起始地址放到地址总线上，而C/BE信号线则首先送出“读命令”信号。
- (b) 当CLK②开始时，目标设备将会识别AD线上的地址信号。
- (c) 发送端停止驱动AD总线。所有可能由多个设备驱动的信号线要求一个切换周期（用两个环形的箭头表示），这样，地址信号线会失效而使总线被目标设备所用。发送端修改C/BE线上的信息，以指示AD线传送数据中有哪些字节有效（1~4B）。发送端同时使IRDY降为低电平（有效），表示它已准备接受第1个数据项。
- (d) 被选中目标的DEVSEL信号有效（降为低电平），表示收到了有效的地址，并将响应。目标设备将所要求的数据放到AD总线上并使TRDY信号有效（降为低电平），表示已将有效的数据放在AD总线上了。
- (e) 发送端在CLK④的开始时读数据，并改变C/BE字节指示信号，为下一次读作准备。
- (f) 在这个例子中，目标设备需要准备一些时间为第2块数据的传输作准备。因此，它将TRDY置为无效（高电平），以通知发送端“下一周期没有新的数据”。相应地，发送端在CLK⑤开始时不会读数据，并且在这个周期中不改变字节允许信号。第2块数据在CLK⑥开始时被读取。
- (g) 在CLK⑥周期中，目标应将第3块数据项放到总线上。但是，在这个例子中，发送端没有准备好读数据（例如，它暂时处在缓冲区满的状态）。于是，它使IRDY无效（变为高电平），迫使目标设备的第3块数据项多保持一个时钟周期。
- (h) 发送端知道传送的第3个数据是最后一个，因此它使FRAME变为高电平（无效），以通知目标这是最后一次数据传送，同时发送端再次使IRDY降为低电平（有效），表示它已准备好完成这次传送。
- (i) 完成传输后发送端取消IRDY，使总线变为空闲状态。同时目标使IRDY和DEVSEL处于无效。

## 3.5.4 仲裁

PCI使用集中式的同步仲裁方法，主控方有独立的请求（REQ）信号和准许（GNT）信号。这些信号线连到中央仲裁器。它使用简单的“请求-准许”的“握手”联络方式来准许对总线的访问。  
PCI规范没有规定具体的仲裁算法。仲裁器能够使用“先到先服务”的方法、“轮转”方法或某种优先方法。PCI主控方必须为它期望完成的每个事项进行仲裁，单一事项包括一个地址周期，后面跟着一个或多个数据周期。

![两个主控方之间的PCI总线仲裁](/img/两个主控方之间的PCI总线仲裁.jpg/)
上图给出两个设备A和B为使用总线进行仲裁的例子，仲裁的时序如下：
- (a) 在CLK①开始前，A已经产生了低电平的REQ信号（有效），仲裁器在CLK①的开始时采样到这一信号。
- (b) 在CLK①中，B的REQ信号变为低电平（有效），请求使用总线。
- (c) 同时，仲裁器输出的GNT-A变为低电平，准许A访问总线。
- (d) A在CLK②的开始时采样到GNT-A，知道它已经被准许访问总线。同时它发现IRDY和TRDY此时仍未无效的高电平，表明此时总线空闲。因此，A使FRAME信号有效（降为低电平）并将地址放到AD总线上，将命令放到C/BE总线上（没有画出）。同时A继续使REQ-A保持有效，因为它随后要执行下一个事项。
- (e) 总线仲裁器在CLK③的开始时对所有REQ线采样，并决定准许B进行下一事项，然后，它声明GNT-B有效并撤销GNT-A。B只有等到总线恢复为空闲状态时，才能够使用总线。
- (f) A撤销FRAME，表示正在进行最后一次数据传输，同时把数据放到数据总线上，并通过IRDY降为低电平，通知目标设备，使目标设备在下一个周期开始时读数据。
- (g) 在CLK⑤时钟周期开始时，B发现IRDY和FRAME已经呈无效状态，因此将FRAME置为低电平取得总线的控制权。同时它取消ERQ，因为它只想完成一个事项。
- 随后，A被授予总线访问权，以进行下一事项。

仲裁可以在当前总线主控方进行数据传送的时候同时发生。因此，总线仲裁不浪费总线周期，这称为“隐式仲裁”。